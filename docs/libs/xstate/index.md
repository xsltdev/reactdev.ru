# XState

![XState](https://user-images.githubusercontent.com/1093738/101672561-06aa7480-3a24-11eb-89d1-787fa7112138.png)

[ÐšÐ¾Ð½ÐµÑ‡Ð½Ñ‹Ðµ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ñ‹](https://ru.wikipedia.org/wiki/%D0%9A%D0%BE%D0%BD%D0%B5%D1%87%D0%BD%D1%8B%D0%B9_%D0%B0%D0%B2%D1%82%D0%BE%D0%BC%D0%B0%D1%82) Ð¸ [Ð´Ð¸Ð°Ð³Ñ€Ð°Ð¼Ð¼Ñ‹ ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ð¹](https://www.sciencedirect.com/science/article/pii/0167642387900359/pdf) Ð´Ð»Ñ ÑÐ¾Ð²Ñ€ÐµÐ¼ÐµÐ½Ð½Ð¾Ð³Ð¾ Ð˜Ð½Ñ‚ÐµÑ€Ð½ÐµÑ‚Ð°.

ÐÐ¾Ð²Ð¸Ñ‡Ð¾Ðº Ð² ÐºÐ¾Ð½ÐµÑ‡Ð½Ñ‹Ñ… Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð°Ñ… Ð¸ Ð´Ð¸Ð°Ð³Ñ€Ð°Ð¼Ð°Ñ… ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ð¹? ÐŸÑ€Ð¾Ñ‡Ñ‚Ð¸Ñ‚Ðµ Ð½Ð°ÑˆÐµ [Ð²Ð²ÐµÐ´ÐµÐ½Ð¸Ðµ](guides/introduction-to-state-machines-and-statecharts.md).

## ÐŸÐ°ÐºÐµÑ‚Ñ‹

- ðŸ¤– `xstate` - Ð‘Ð°Ð·Ð¾Ð²Ð°Ñ Ð±Ð¸Ð±Ð»Ð¸Ð¾Ñ‚ÐµÐºÐ° ÐºÐ¾Ð½ÐµÑ‡Ð½Ñ‹Ñ… Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¾Ð² Ð¸ Ð´Ð¸Ð°Ð³Ñ€Ð°Ð¼Ð¼ ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ð¹ + Ð¸Ð½Ñ‚ÐµÑ€Ð¿Ñ€ÐµÑ‚Ð°Ñ‚Ð¾Ñ€
- [ðŸ”¬ `@xstate/fsm`](https://github.com/statelyai/xstate/tree/main/packages/xstate-fsm) - ÐœÐ¸Ð½Ð¸Ð¼Ð°Ð»ÑŒÐ½Ð°Ñ Ð±Ð¸Ð±Ð»Ð¸Ð¾Ñ‚ÐµÐºÐ° ÐºÐ¾Ð½ÐµÑ‡Ð½Ñ‹Ñ… Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¾Ð²
- [ðŸ“‰ `@xstate/graph`](https://github.com/statelyai/xstate/tree/main/packages/xstate-graph) - Ð£Ñ‚Ð¸Ð»Ð¸Ñ‚Ñ‹ Ð¾Ð±Ñ…Ð¾Ð´Ð° Ð³Ñ€Ð°Ñ„Ð° Ð´Ð»Ñ XState
- [âš›ï¸ `@xstate/react`](https://github.com/statelyai/xstate/tree/main/packages/xstate-react) - React xÑƒÐºÐ¸ Ð¸ ÑƒÑ‚Ð¸Ð»Ð¸Ñ‚Ñ‹ Ð´Ð»Ñ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ñ XState Ð² Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸ÑÑ… React
- [ðŸ’š `@xstate/vue`](https://github.com/statelyai/xstate/tree/main/packages/xstate-vue) - Ð¤ÑƒÐ½ÐºÑ†Ð¸Ð¸ ÐºÐ¾Ð¼Ð¿Ð¾Ð·Ð¸Ñ†Ð¸Ð¸ Ð¸ ÑƒÑ‚Ð¸Ð»Ð¸Ñ‚Ñ‹ Vue Ð´Ð»Ñ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ñ XState Ð² Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸ÑÑ… Vue
- [ðŸŽ· `@xstate/svelte`](https://github.com/statelyai/xstate/tree/main/packages/xstate-svelte) - Ð£Ñ‚Ð¸Ð»Ð¸Ñ‚Ñ‹ Svelte Ð´Ð»Ñ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ñ XState Ð² Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸ÑÑ… Svelte
- [âœ… `@xstate/test`](https://github.com/statelyai/xstate/tree/main/packages/xstate-test) - Ð£Ñ‚Ð¸Ð»Ð¸Ñ‚Ñ‹ Model-Based-Testing (Ñ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸ÐµÐ¼ XState) Ð´Ð»Ñ Ñ‚ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ Ð»ÑŽÐ±Ð¾Ð³Ð¾ Ð¿Ñ€Ð¾Ð³Ñ€Ð°Ð¼Ð¼Ð½Ð¾Ð³Ð¾ Ð¾Ð±ÐµÑÐ¿ÐµÑ‡ÐµÐ½Ð¸Ñ
- [ðŸ” `@xstate/inspect`](https://github.com/statelyai/xstate/tree/main/packages/xstate-inspect) - Ð£Ñ‚Ð¸Ð»Ð¸Ñ‚Ñ‹ Ñ€Ð°Ð·Ñ€Ð°Ð±Ð¾Ñ‚Ñ‡Ð¸ÐºÐ° (Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ¸) Ð´Ð»Ñ XState

## Ð¨Ð°Ð±Ð»Ð¾Ð½Ñ‹

ÐÐ°Ñ‡Ð½Ð¸Ñ‚Ðµ Ñ ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ñ Ñ„Ð¾Ñ€ÐºÐ° Ð¾Ð´Ð½Ð¾Ð³Ð¾ Ð¸Ð· ÑÑ‚Ð¸Ñ… ÑˆÐ°Ð±Ð»Ð¾Ð½Ð¾Ð² Ð½Ð° CodeSandbox:

- [XState Template](https://codesandbox.io/s/xstate-example-template-m4ckv) - Ð±ÐµÐ· Ñ„Ñ€ÐµÐ¹Ð¼Ð²Ð¾Ñ€ÐºÐ¾Ð²
- [XState + TypeScript Template](https://codesandbox.io/s/xstate-typescript-template-s9kz8) - Ð±ÐµÐ· Ñ„Ñ€ÐµÐ¹Ð¼Ð²Ð¾Ñ€ÐºÐ¾Ð²
- [XState + React Template](https://codesandbox.io/s/xstate-react-template-3t2tg)
- [XState + React + TypeScript Template](https://codesandbox.io/s/xstate-react-typescript-template-wjdvn)
- [XState + Vue Template](https://codesandbox.io/s/xstate-vue-template-composition-api-1n23l)
- [XState + Vue 3 Template](https://codesandbox.io/s/xstate-vue-3-template-vrkk9)
- [XState + Svelte Template](https://codesandbox.io/s/xstate-svelte-template-jflv1)

## Ð¡ÑƒÐ¿ÐµÑ€ Ð±Ñ‹ÑÑ‚Ñ€Ñ‹Ð¹ ÑÑ‚Ð°Ñ€Ñ‚

```bash
npm install xstate
```

```js
import { createMachine, interpret } from 'xstate';

// Stateless machine definition
// machine.transition(...) is a pure function used by the interpreter.
const toggleMachine = createMachine({
  id: 'toggle',
  initial: 'inactive',
  states: {
    inactive: {
      on: {
        TOGGLE: { target: 'active' },
      },
    },
    active: {
      on: {
        TOGGLE: { target: 'inactive' },
      },
    },
  },
});

// Machine instance with internal state
const toggleService = interpret(toggleMachine)
  .onTransition((state) => console.log(state.value))
  .start();
// => 'inactive'

toggleService.send({ type: 'TOGGLE' });
// => 'active'

toggleService.send({ type: 'TOGGLE' });
// => 'inactive'
```

## ÐŸÑ€Ð¸Ð¼ÐµÑ€ Ñ Promise

[ðŸ“‰ See the visualization on stately.ai/viz](https://stately.ai/viz?gist=bbcb4379b36edea0458f597e5eec2f91)

```js
import { createMachine, interpret, assign } from 'xstate';

const fetchMachine = createMachine({
  id: 'Dog API',
  initial: 'idle',
  context: {
    dog: null,
  },
  states: {
    idle: {
      on: {
        FETCH: { target: 'loading' },
      },
    },
    loading: {
      invoke: {
        id: 'fetchDog',
        src: (context, event) =>
          fetch(
            'https://dog.ceo/api/breeds/image/random'
          ).then((data) => data.json()),
        onDone: {
          target: 'resolved',
          actions: assign({
            dog: (_, event) => event.data,
          }),
        },
        onError: {
          target: 'rejected',
        },
      },
      on: {
        CANCEL: { target: 'idle' },
      },
    },
    rejected: {
      on: {
        FETCH: { target: 'loading' },
      },
    },
    resolved: {
      type: 'final',
    },
  },
});

const dogService = interpret(fetchMachine)
  .onTransition((state) => console.log(state.value))
  .start();

dogService.send({ type: 'FETCH' });
```

## Ð’Ð¸Ð·ÑƒÐ°Ð»Ð¸Ð·Ð°Ñ‚Ð¾Ñ€

**[Ð’Ð¸Ð·ÑƒÐ°Ð»Ð¸Ð·Ð¸Ñ€ÑƒÐ¹Ñ‚Ðµ, Ð¼Ð¾Ð´ÐµÐ»Ð¸Ñ€ÑƒÐ¹Ñ‚Ðµ Ð¸ Ð´ÐµÐ»Ð¸Ñ‚ÐµÑÑŒ ÑÐ²Ð¾Ð¸Ð¼Ð¸ Ð´Ð¸Ð°Ð³Ñ€Ð°Ð¼Ð¼Ð°Ð¼Ð¸ ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ð¹ Ð² XState Viz!](https://stately.ai/viz)**

[![XState Visualizer](3pEB0B3.png)](https://stately.ai/viz)

## ÐŸÐ¾Ñ‡ÐµÐ¼Ñƒ?

**Ð”Ð¸Ð°Ð³Ñ€Ð°Ð¼Ð¼Ñ‹ ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ð¹** - ÑÑ‚Ð¾ Ñ„Ð¾Ñ€Ð¼Ð°Ð»Ð¸Ð·Ð¼ Ð´Ð»Ñ Ð¼Ð¾Ð´ÐµÐ»Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ Ñ€ÐµÐ°ÐºÑ‚Ð¸Ð²Ð½Ñ‹Ñ… ÑÐ¸ÑÑ‚ÐµÐ¼ Ñ Ð¾Ñ‚ÑÐ»ÐµÐ¶Ð¸Ð²Ð°Ð½Ð¸ÐµÐ¼ ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ñ. Ð­Ñ‚Ð¾ Ð¿Ð¾Ð»ÐµÐ·Ð½Ð¾ Ð´Ð»Ñ Ð´ÐµÐºÐ»Ð°Ñ€Ð°Ñ‚Ð¸Ð²Ð½Ð¾Ð³Ð¾ Ð¾Ð¿Ð¸ÑÐ°Ð½Ð¸Ñ _Ð¿Ð¾Ð²ÐµÐ´ÐµÐ½Ð¸Ñ_ Ð²Ð°ÑˆÐµÐ³Ð¾ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ, Ð¾Ñ‚ Ð¾Ñ‚Ð´ÐµÐ»ÑŒÐ½Ñ‹Ñ… ÐºÐ¾Ð¼Ð¿Ð¾Ð½ÐµÐ½Ñ‚Ð¾Ð² Ð´Ð¾ Ð¾Ð±Ñ‰ÐµÐ¹ Ð»Ð¾Ð³Ð¸ÐºÐ¸ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ.

Ð¡Ð¼Ð¾Ñ‚Ñ€Ð¸Ñ‚Ðµ [ðŸ“½ ÑÐ»Ð°Ð¹Ð´Ñ‹](http://slides.com/davidkhourshid/finite-state-machines) ([ðŸŽ¥ Ð²Ð¸Ð´ÐµÐ¾](https://www.youtube.com/watch?v=VU1NKX6Qkxc)) Ð¸Ð»Ð¸ Ð¾Ð·Ð½Ð°ÐºÐ¾Ð¼ÑŒÑ‚ÐµÑÑŒ Ñ ÑÑ‚Ð¸Ð¼Ð¸ Ñ€ÐµÑÑƒÑ€ÑÐ°Ð¼Ð¸, Ñ‡Ñ‚Ð¾Ð±Ñ‹ ÑƒÐ·Ð½Ð°Ñ‚ÑŒ Ð¾ Ð²Ð°Ð¶Ð½Ð¾ÑÑ‚Ð¸ ÐºÐ¾Ð½ÐµÑ‡Ð½Ñ‹Ñ… Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¾Ð² Ð¸ Ð´Ð¸Ð°Ð³Ñ€Ð°Ð¼Ð¼ ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ð¹ Ð² Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒÑÐºÐ¸Ñ… Ð¸Ð½Ñ‚ÐµÑ€Ñ„ÐµÐ¹ÑÐ°Ñ…:

- [Statecharts - A Visual Formalism for Complex Systems](https://www.sciencedirect.com/science/article/pii/0167642387900359/pdf), Ð°Ð²Ñ‚Ð¾Ñ€ David Harel
- [The World of Statecharts](https://statecharts.github.io/), Ð°Ð²Ñ‚Ð¾Ñ€ Erik Mogensen
- [Pure UI](https://rauchg.com/2015/pure-ui), Ð°Ð²Ñ‚Ð¾Ñ€ Guillermo Rauch
- [Pure UI Control](https://medium.com/@asolove/pure-ui-control-ac8d1be97a8d), Ð°Ð²Ñ‚Ð¾Ñ€ Adam Solove
- [Spectrum - Statecharts Community](https://spectrum.chat/statecharts) (Ð”Ð»Ñ Ð²Ð¾Ð¿Ñ€Ð¾ÑÐ¾Ð², ÑÐ²ÑÐ·Ð°Ð½Ð½Ñ‹Ñ… Ñ XState, Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹Ñ‚Ðµ [GitHub Discussions](https://github.com/statelyai/xstate/discussions))

## ÐšÐ¾Ð½ÐµÑ‡Ð½Ñ‹Ðµ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ñ‹

![Light Machine](rqqmkJh.png)

```js
import { createMachine } from 'xstate';

const lightMachine = createMachine({
  id: 'light',
  initial: 'green',
  states: {
    green: {
      on: {
        TIMER: { target: 'yellow' },
      },
    },
    yellow: {
      on: {
        TIMER: { target: 'red' },
      },
    },
    red: {
      on: {
        TIMER: { target: 'green' },
      },
    },
  },
});

const currentState = 'green';

const nextState = lightMachine.transition(currentState, {
  type: 'TIMER',
}).value;

// => 'yellow'
```

## Ð˜ÐµÑ€Ð°Ñ€Ñ…Ð¸Ñ‡ÐµÑÐºÐ¸Ðµ (Ð²Ð»Ð¾Ð¶ÐµÐ½Ð½Ñ‹Ðµ) ÐºÐ¾Ð½ÐµÑ‡Ð½Ñ‹Ðµ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ñ‹

![Hierarchical Light Machine](GDZAeB9.png)

```js
import { createMachine } from 'xstate';

const pedestrianStates = {
  initial: 'walk',
  states: {
    walk: {
      on: {
        PED_TIMER: { target: 'wait' },
      },
    },
    wait: {
      on: {
        PED_TIMER: { target: 'stop' },
      },
    },
    stop: {},
  },
};

const lightMachine = createMachine({
  id: 'light',
  initial: 'green',
  states: {
    green: {
      on: {
        TIMER: { target: 'yellow' },
      },
    },
    yellow: {
      on: {
        TIMER: { target: 'red' },
      },
    },
    red: {
      on: {
        TIMER: { target: 'green' },
      },
      ...pedestrianStates,
    },
  },
});

const currentState = 'yellow';

const nextState = lightMachine.transition(currentState, {
  type: 'TIMER',
}).value;
// => {
//   red: 'walk'
// }

lightMachine.transition('red.walk', { type: 'PED_TIMER' })
  .value;
// => {
//   red: 'wait'
// }
```

**Ð¾Ð±ÑŠÐµÐºÑ‚Ð½Ð°Ñ Ð½Ð¾Ñ‚Ð°Ñ†Ð¸Ñ Ð´Ð»Ñ Ð¸ÐµÑ€Ð°Ñ€Ñ…Ð¸Ñ‡ÐµÑÐºÐ¸Ñ… ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ð¹:**

```js
// ...
const waitState = lightMachine.transition(
  { red: 'walk' },
  { type: 'PED_TIMER' }
).value;

// => { red: 'wait' }

lightMachine.transition(waitState, { type: 'PED_TIMER' })
  .value;

// => { red: 'stop' }

lightMachine.transition({ red: 'stop' }, { type: 'TIMER' })
  .value;

// => 'green'
```

## ÐŸÐ°Ñ€Ð°Ð»Ð»ÐµÐ»ÑŒÐ½Ñ‹Ðµ ÐºÐ¾Ð½ÐµÑ‡Ð½Ñ‹Ðµ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ñ‹

![Parallel state machine](GKd4HwR.png)

```js
import { createMachine } from 'xstate';

const wordMachine = createMachine({
  id: 'word',
  type: 'parallel',
  states: {
    bold: {
      initial: 'off',
      states: {
        on: {
          on: {
            TOGGLE_BOLD: { target: 'off' },
          },
        },
        off: {
          on: {
            TOGGLE_BOLD: { target: 'on' },
          },
        },
      },
    },
    underline: {
      initial: 'off',
      states: {
        on: {
          on: {
            TOGGLE_UNDERLINE: { target: 'off' },
          },
        },
        off: {
          on: {
            TOGGLE_UNDERLINE: { target: 'on' },
          },
        },
      },
    },
    italics: {
      initial: 'off',
      states: {
        on: {
          on: {
            TOGGLE_ITALICS: { target: 'off' },
          },
        },
        off: {
          on: {
            TOGGLE_ITALICS: { target: 'on' },
          },
        },
      },
    },
    list: {
      initial: 'none',
      states: {
        none: {
          on: {
            BULLETS: { target: 'bullets' },
            NUMBERS: { target: 'numbers' },
          },
        },
        bullets: {
          on: {
            NONE: { target: 'none' },
            NUMBERS: { target: 'numbers' },
          },
        },
        numbers: {
          on: {
            BULLETS: { target: 'bullets' },
            NONE: { target: 'none' },
          },
        },
      },
    },
  },
});

const boldState = wordMachine.transition('bold.off', {
  type: 'TOGGLE_BOLD',
}).value;

// {
//   bold: 'on',
//   italics: 'off',
//   underline: 'off',
//   list: 'none'
// }

const nextState = wordMachine.transition(
  {
    bold: 'off',
    italics: 'off',
    underline: 'on',
    list: 'bullets',
  },
  { type: 'TOGGLE_ITALICS' }
).value;

// {
//   bold: 'off',
//   italics: 'on',
//   underline: 'on',
//   list: 'bullets'
// }
```

## Ð˜ÑÑ‚Ð¾Ñ€Ð¸Ñ ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ð¹

![ÐšÐ¾Ð½ÐµÑ‡Ð½Ñ‹Ð¹ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚ Ñ Ð¸ÑÑ‚Ð¾Ñ€Ð¸ÐµÐ¹ ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ð¹](I4QsQsz.png)

```js
import { createMachine } from 'xstate';

const paymentMachine = createMachine({
  id: 'payment',
  initial: 'method',
  states: {
    method: {
      initial: 'cash',
      states: {
        cash: {
          on: {
            SWITCH_CHECK: { target: 'check' },
          },
        },
        check: {
          on: {
            SWITCH_CASH: { target: 'cash' },
          },
        },
        hist: { type: 'history' },
      },
      on: {
        NEXT: { target: 'review' },
      },
    },
    review: {
      on: {
        PREVIOUS: { target: 'method.hist' },
      },
    },
  },
});

const checkState = paymentMachine.transition(
  'method.cash',
  {
    type: 'SWITCH_CHECK',
  }
);

// => State {
//   value: { method: 'check' },
//   history: State { ... }
// }

const reviewState = paymentMachine.transition(checkState, {
  type: 'NEXT',
});

// => State {
//   value: 'review',
//   history: State { ... }
// }

const previousState = paymentMachine.transition(
  reviewState,
  {
    type: 'PREVIOUS',
  }
).value;

// => { method: 'check' }
```
